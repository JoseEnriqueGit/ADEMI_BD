PROCEDURE P_Carga_Precalifica_Campana_Especial(pMensaje IN OUT VARCHAR2) IS BEGIN DECLARE CURSOR CUR_REPRESTAMO IS
SELECT
    R.ID_REPRESTAMO,
    C.TIPO_CREDITO,
    R.ESTADO,
    R.XCORE_GLOBAL,
    R.NO_CREDITO
FROM
    PR_REPRESTAMOS R
    LEFT JOIN PR_CAMPANA_ESPECIALES C ON C.NO_CREDITO = R.NO_CREDITO
    AND C.ID_CAMPANA_ESPECIALES = R.ID_REPRE_CAMPANA_ESPECIALES
WHERE
    R.ESTADO = 'RE';

VMSG VARCHAR2(4000);

v_Id_Represtamo VARCHAR2(400);

v_conteo NUMBER(10);

v_proceso_activo VARCHAR2(4000);

BEGIN v_proceso_activo := PR.PR_PKG_REPRESTAMOS.F_OBT_PARAMETRO_REPRESTAMO('CAMPANA_ESPECIAL_PROCESO_ACTIVO');

-- Nota: El código original usa 'S'. Si en tu versión es 'N', ajústalo aquí.
IF v_proceso_activo = 'S' THEN
UPDATE
    PA.PA_PARAMETROS_MVP
SET
    VALOR = 'S'
WHERE
    CODIGO_MVP = 'REPRESTAMOS'
    AND CODIGO_PARAMETRO = 'CAMPANA_ESPECIAL_PROCESO_ACTIVO';

COMMIT;

--1
PR.PR_PKG_REPRESTAMOS.Precalifica_Campana_Especiales;

BEGIN
SELECT
    COUNT(*) INTO v_conteo
FROM
    PR.PR_REPRESTAMOS R
WHERE
    ESTADO = 'RE';

DBMS_OUTPUT.PUT_LINE('v_conteo = ' || v_conteo);

END;

--2
PR.PR_PKG_REPRESTAMOS.Actualiza_Preca_Campana_Especiale;

--3
PR_PKG_REPRESTAMOS.ACTUALIZA_XCORE_CAMPANA_ESPECIAL;

FOR A IN CUR_REPRESTAMO LOOP PR.PR_PKG_REPRESTAMOS.P_Registra_Solicitud_Campana(
    A.ID_REPRESTAMO,
    A.TIPO_CREDITO,
    NVL(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER),
    VMSG
);

COMMIT;

END LOOP;

--5
IF PR_PKG_REPRESTAMOS.f_obt_parametro_Represtamo('VALIDAR_XCORE_CAMPANA') = 'S' THEN PR.PR_PKG_REPRESTAMOS.PVALIDA_XCORE();

DBMS_OUTPUT.PUT_LINE('VALIDO EL XCORE');

COMMIT;

END IF;

FOR A IN CUR_REPRESTAMO LOOP p_generar_bitacora(
    A.ID_REPRESTAMO,
    NULL,
    'RE',
    NULL,
    '',
    NVL(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER)
);

UPDATE
    PR.PR_CAMPANA_ESPECIALES
SET
    ESTADO = 'F',
    FECHA_MODIFICACION = SYSDATE,
    MODIFICADO_POR = NVL(SYS_CONTEXT('APEX$SESSION', 'APP_USER'), USER)
WHERE
    NO_CREDITO = A.NO_CREDITO
    AND ESTADO = 'T';

COMMIT;

-- validar que tenga solicitud, que tenga canales
IF F_Existe_Solicitudes(A.ID_REPRESTAMO)
AND F_Existe_Canales(A.ID_REPRESTAMO)
AND PR.PR_PKG_REPRESTAMOS.F_EXISTE_CREDITO(A.ID_REPRESTAMO) THEN PR.PR_PKG_REPRESTAMOS.P_Generar_Bitacora(
    A.ID_REPRESTAMO,
    NULL,
    'NP',
    NULL,
    'Notificación Pendiente',
    USER
);

ELSE IF PR.PR_PKG_REPRESTAMOS.F_EXISTE_CREDITO(A.ID_REPRESTAMO) = FALSE THEN PR.PR_PKG_REPRESTAMOS.P_Generar_Bitacora(
    A.ID_REPRESTAMO,
    NULL,
    'RXT',
    NULL,
    'No cumple con los criterios: Tipo de Credito ',
    USER
);

ELSE IF F_Existe_Solicitudes(A.ID_REPRESTAMO)
AND F_Existe_Canales(A.ID_REPRESTAMO) = FALSE
AND PR.PR_PKG_REPRESTAMOS.F_EXISTE_CREDITO(A.ID_REPRESTAMO) THEN PR.PR_PKG_REPRESTAMOS.P_Generar_Bitacora(
    A.ID_REPRESTAMO,
    NULL,
    'CP',
    NULL,
    'Solicitud Pendiente de Canal',
    USER
);

ELSE PR.PR_PKG_REPRESTAMOS.P_Generar_Bitacora(
    A.ID_REPRESTAMO,
    NULL,
    'AN',
    NULL,
    'No cumple con los criterios: Solicitudes,Opciones',
    USER
);

END IF;

END IF;

END IF;

END LOOP;

/**********************************************************************************/
DECLARE v_current_log_value VARCHAR2(4000);

v_new_log_entry VARCHAR2(255);

v_final_log_value VARCHAR2(4000);

v_exec_count NUMBER;

v_first_brace_pos NUMBER;

BEGIN -- 1. Obtener el valor actual del log y bloquear la fila para evitar concurrencia.
SELECT
    VALOR INTO v_current_log_value
FROM
    PA.PA_PARAMETROS_MVP
WHERE
    CODIGO_MVP = 'REPRESTAMOS'
    AND CODIGO_PARAMETRO = 'CAMPANA_ESPECIAL_EJECUCIONES' FOR
UPDATE
;

-- 2. Calcular el número de ejecución a partir del valor actual.
v_exec_count := NVL(REGEXP_COUNT(v_current_log_value, '}') + 1, 1);

-- 3. Construir la nueva entrada de log.
v_new_log_entry := '{"F":"' || TO_CHAR(SYSDATE, 'dd/mm/yyyy hh:mi:ss') || '","R":' || v_conteo || ',"E":' || v_exec_count || '}';

-- 4. Verificar si añadir la nueva entrada excederá el límite (usamos 3800 como margen de seguridad).
IF (
    NVL(LENGTH(v_current_log_value), 0) + LENGTH(v_new_log_entry) + 1
) > 3800 THEN -- Si excede, eliminar la entrada más antigua (la primera).
v_first_brace_pos := INSTR(v_current_log_value, '}');

IF v_first_brace_pos > 0 THEN IF SUBSTR(v_current_log_value, v_first_brace_pos + 1, 1) = ',' THEN v_current_log_value := SUBSTR(v_current_log_value, v_first_brace_pos + 2);

ELSE v_current_log_value := SUBSTR(v_current_log_value, v_first_brace_pos + 1);

END IF;

END IF;

END IF;

-- 5. Construir el valor final, añadiendo una coma si es necesario.
v_final_log_value := v_current_log_value || (
    CASE
        WHEN NVL(LENGTH(v_current_log_value), 0) > 0 THEN ','
        ELSE ''
    END
) || v_new_log_entry;

-- 6. Actualizar la tabla con el nuevo valor del log.
UPDATE
    PA.PA_PARAMETROS_MVP
SET
    VALOR = v_final_log_value
WHERE
    CODIGO_MVP = 'REPRESTAMOS'
    AND CODIGO_PARAMETRO = 'CAMPANA_ESPECIAL_EJECUCIONES';

EXCEPTION
WHEN OTHERS THEN ROLLBACK;

RAISE;

END;

/**********************************************************************************/
COMMIT;

UPDATE
    PA.PA_PARAMETROS_MVP
SET
    VALOR = 'N'
WHERE
    CODIGO_MVP = 'REPRESTAMOS'
    AND CODIGO_PARAMETRO = 'CAMPANA_ESPECIAL_PROCESO_ACTIVO';

COMMIT;

END IF;

END;

EXCEPTION
WHEN OTHERS THEN DECLARE vIdError PLS_INTEGER := 0;

BEGIN IA.LOGGER.ADDPARAMVALUEV('pMensaje', pMensaje);

setError(
    pProgramUnit = > 'P_Carga_Precalifica_Campana_Especial',
    pPieceCodeName = > NULL,
    pErrorDescription = > SQLERRM,
    pErrorTrace = > DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,
    pEmailNotification = > NULL,
    pParamList = > IA.LOGGER.vPARAMLIST,
    pOutputLogger = > FALSE,
    pExecutionTime = > NULL,
    pIdError = > vIdError
);

END;

END P_Carga_Precalifica_Campana_Especial;